#!/usr/bin/perl
use warnings;
use strict;
use Cwd;
use File::Basename qw(basename dirname fileparse);

########################################################################################################################
#                                                                                                                      #
#   PostprocessBuildPlayer - v0.2                                                                                      #
#                                                                                                                      #
#   Revision History:                                                                                                  #
#   2007-NOV-15 : Script updated to v0.2 by Tom Higgins (tom@unity3d.com)                                              #
#                 - Verified compatibility with Unity versions 1.6.2 and 2.x                                           #
#   2007-JUL-05 : Script v0.1 created by Tom Higgins (tom@unity3d.com)                                                 #
#                 - Script written to be compatible with Unity 1.6.2                                                   #
#                                                                                                                      #
########################################################################################################################


# Publish Arguments (Do not edit!) #####################################################################################

# Unity-Provided Publish Arguments
my $PublishFile =     $ARGV[0];  # The published file (stand-alone, unityweb) path
my $PublishTarget =   $ARGV[1];  # Publish output target (stand-alone, web player, etc.)
my $CompanyName =     $ARGV[3];  # Company name as it appears under Edit > Project Settings > Player
my $ProductName =     $ARGV[4];  # Product name as it appears under Edit > Project Settings > Player
my $DisplayWidth =    $ARGV[5];  # The default display width as it appears under Edit > Project Settings > Player
my $DisplayHeight =   $ARGV[6];  # The default display height as it appears under Edit > Project Settings > Player
	
# Parse the published web player file path into a file name, folder and suffix
my ($PublishFileName, $PublishFolder, $PublishSuffix) = fileparse($PublishFile, qr/\.[^.]*/);	


print "PublishFile:   $PublishFile\n";
print "PublishTarget: $PublishTarget\n";
print "CompanyName:   $CompanyName\n";
print "ProductName:   $PublishTarget\n";
print "DisplayWidth:  $DisplayWidth\n";
print "DisplayHeight: $DisplayHeight\n";


### Tasks
#
# 1. Add the following frameworks to the project:
#       - Kamcord
#       - AWSiOSSDK
#       
#       - Accounts
#       - CoreData
#       - MessageUI
#       - Security
#       - Twitter

my $xcodeProjectFile  = $PublishFile . "/Unity-iPhone.xcodeproj";
my $appControllerFile = $PublishFile . "/Classes/AppController.mm";

print "AppController file: $appControllerFile\n";

# 2. Find the first #import statement and Import <Kamcord/iPhone_GlesSupport_Kamcord.h> above that for simplicity
my $KamcordImport = "#import <Kamcord/iPhone_GlesSupport_Kamcord.h>";

# 3. Replac
#   - CreateSurfaceGLES(surface)     --> CreateSurfaceGLES(surface, _context, UnityGetGLViewController())
#   - DestroySurfaceGLES(...)        --> DestroySurfaceGLES_Kamcord(...)
#   - PreparePresentSurfaceGLES(...) --> PreparePresentSurfaceGLES_Kamcord(...)
#   - AfterPresentSurfaceGLES(...)   --> AfterPresentSurfaceGLES_Kamcord(...)
my %replaceMapping = (
    'CreateSurfaceGLES\\(surface\\)' => 'CreateSurfaceGLES_Kamcord(surface, _context, UnityGetGLViewController())',
    'DestroySurfaceGLES'         => 'DestroySurfaceGLES_Kamcord',
    'PreparePresentSurfaceGLES'  => 'PreparePresentSurfaceGLES_Kamcord',
    'AfterPresentSurfaceGLES'    => 'AfterPresentSurfaceGLES_Kamcord',
);


###
### Do it
###


# Open and read the web player template file
open(AppControllerFH, "+<" . $appControllerFile) or die "Can't open $appControllerFile: $!\n";

# So disgusting: read the entire file into memory
my @file = <AppControllerFH>;

print "NumLines: ", scalar(@file), "\n";

# Seek to the beginning of the file
seek (AppControllerFH, 0, 0);

my $importedKamcord = 0;
my $includeToMatch = quotemeta("#include <mach/mach_time.h>");

# Start substituting
foreach my $line (@file)
{
    while (my ($key, $value) = each(%replaceMapping))
    {
        # Insert the Kamcord import above this specific line
        if (!$importedKamcord)
        {
            if ($line =~ /$includeToMatch/)
            {
                print AppControllerFH $KamcordImport, "\n\n";
                $importedKamcord = 1;
            }
        }

        # Do some search and replace
        if ($line =~ /$key/)
        {
            $line =~ s/$key/$value/g;
        }
    }
    print AppControllerFH $line;
}
close(AppControllerFH);



### Now execute the second post process build player script
my $secondScriptExecutor = "python";
my $secondPostProcesScriptName = join("/", getcwd(), "Assets", "Editor", "PostprocessBuildPlayer_Kamcord2");
my @cmd = ($secondScriptExecutor, $secondPostProcesScriptName, $PublishFile);

print "[Executing @cmd.]\n";
system(@cmd);
print "[Finished executing @cmd.]\n";

